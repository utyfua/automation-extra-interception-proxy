# automation-extra-interception-proxy

Simple way to play with a site requests and responses by the plugin for puppeteer-extra.

Using a proxy is optional.

Tested in `puppeteer/chromium` only! (including `puppeteer@14`)

## Installing

Using npm

    npm install automation-extra-interception-proxy

Using yarn

    yarn add automation-extra-interception-proxy

## [Open usage samples](https://github.com/utyfua/automation-extra-interception-proxy/tree/master/samples)

# Why?

## 1. Traffic sniffing

Time to time required to reach information from the browser request. By default you can reach easily only to headers information. If you want to just read all responses you also can do that but time to time it will throw errors by one of next reasons.

At first page can be already closed and then your code will throw an error.

At second some sites using service workers for requesting some information. Unfortunately you cant handle this situation without manual requesting and then converting to puppeteer.

## 2. Data manipulation

If you want just adjust some requests or responses you should do that manually.

Example. You want get original request/response and do some adjustments. This package will help do that easily. You just getting what you want by single function call.

## 3. Set proxy

Yes, puppeteer already have a proxy support throw additional process arguments. But you should manually maintain proxy credentials each request(?, not sure). Also you cant use socks proxy(?, not sure).

## 4. Asynchronous decisions for requests

Even with cooperative mode you can not make your decisions asynchronously. Here you can chain of handlers with will proceed request decision one by one. Also you can say that this is latest decision and no need to ask another handlers in the chain. Also in one handler you can can adjust request/response for the next one.

# Motivation

We live in the world where almost each website have internal api. When you are looking at the network tab in Chrome DevTools its easy to handle where and what. Data already yours but you cant just get what you want. But you have to fight for the information you desired for. So lets fight together!

# API

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### Table of Contents

*   [wrapPage](#wrappage)
    *   [Parameters](#parameters)
*   [IConfig](#iconfig)
    *   [cooperativePriority](#cooperativepriority)
    *   [requestMode](#requestmode)
    *   [proxy](#proxy)
    *   [agent](#agent)
    *   [logger](#logger)
    *   [timeout](#timeout)
    *   [nativeContinueIfPossible](#nativecontinueifpossible)
    *   [gotHooks](#gothooks)
*   [continue](#continue)
*   [flushLocal](#flushlocal)
    *   [Parameters](#parameters-1)
*   [recordError](#recorderror)
    *   [Parameters](#parameters-2)
*   [recordInternalError](#recordinternalerror)
    *   [Parameters](#parameters-3)
*   [recordWarning](#recordwarning)
    *   [Parameters](#parameters-4)
*   [RequestMode](#requestmode-1)
    *   [ignore](#ignore)
    *   [native](#native)
    *   [managed](#managed)
*   [RequestStage](#requeststage)
    *   [gotRequest](#gotrequest)
    *   [sentRequest](#sentrequest)
    *   [gotResponse](#gotresponse)
    *   [sentResponse](#sentresponse)
    *   [closed](#closed)
*   [IRequestOptions](#irequestoptions)
    *   [method](#method)
    *   [url](#url)
    *   [headers](#headers)
    *   [body](#body)
*   [IAbortReason](#iabortreason)
*   [InterceptionProxyRequest](#interceptionproxyrequest)
    *   [Parameters](#parameters-5)

## wrapPage

[src/index.ts:22-24](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/index.ts#L22-L24 "Source code on GitHub")

Add interception ability to the page [(sample)](https://github.com/utyfua/automation-extra-interception-proxy/blob/master/samples/singlePageInterception.js)

### Parameters

*   `page` **Puppeteer.Page** Page for future interceptions
*   `config` **[IConfig](#iconfig)?** 

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)\<InterceptionProxyPageConfig>** 

## IConfig

[src/interfaces/base.ts:41-103](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/base.ts#L41-L103 "Source code on GitHub")

Plugin configuration object

### cooperativePriority

[src/interfaces/base.ts:51-51](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/base.ts#L51-L51 "Source code on GitHub")

Puppeteer' "Cooperative Intercept Mode" `priority`

This package using own way to manage cooperation

Use only if you know what it does

[\[Read more\]](https://github.com/puppeteer/puppeteer/blob/v10.2.0/docs/api.md#cooperative-intercept-mode-and-legacy-intercept-mode)

Type: ([undefined](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/undefined) | [number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number))

### requestMode

[src/interfaces/base.ts:61-61](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/base.ts#L61-L61 "Source code on GitHub")

`ignore` - Plugin will do nothing about original request

`native` - Plugin will just listen to the original request/response data and all requests will fulfilled by puppeteer itself. But some plugin functionality can be unavailable.

`managed` - Plugin will do all requests by `requestHandlers` or by himself. All plugin features will be available.

Default - managed

Type: [RequestMode](#requestmode)

### proxy

[src/interfaces/base.ts:69-69](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/base.ts#L69-L69 "Source code on GitHub")

Proxy for request

Automatically sets `agent` property using [proxy-agent](https://www.npmjs.com/package/proxy-agent)

Default `null`

Type: ([string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String) | null)

### agent

[src/interfaces/base.ts:77-77](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/base.ts#L77-L77 "Source code on GitHub")

Your agent hot handling requests

Cleans proxy if sets directly

Default `null`

Type: (Agent | null)

### logger

[src/interfaces/base.ts:81-81](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/base.ts#L81-L81 "Source code on GitHub")

You can handle all plugins messages

Type: any

### timeout

[src/interfaces/base.ts:85-85](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/base.ts#L85-L85 "Source code on GitHub")

Request timeout in milliseconds(actual execution only)

Type: [number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)

### nativeContinueIfPossible

[src/interfaces/base.ts:92-92](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/base.ts#L92-L92 "Source code on GitHub")

If you didn't changed request or response, let puppeteer handle this request by himself

Default: `false`

Type: [boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)

### gotHooks

[src/interfaces/base.ts:100-100](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/base.ts#L100-L100 "Source code on GitHub")

*   **See**: <https://github.com/sindresorhus/got/blob/main/documentation/9-hooks.md>

It is not recommended to use. Use another library properties to do it.

Modify requests in more advanced way through interaction with got.

Type: Hooks

## continue

[src/interfaces/classes.ts:42-42](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/classes.ts#L42-L42 "Source code on GitHub")

Will send gathered response back to the puppeteer immediately

If response not collected yet will call getResponse first.

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)\<void>** 

## flushLocal

[src/interfaces/mixins.ts:37-37](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/mixins.ts#L37-L37 "Source code on GitHub")

Flush local configuration

### Parameters

*   `key` **any?** If provided will flush only specific parameter at local level

Returns **void** 

## recordError

[src/interfaces/mixins.ts:47-51](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/mixins.ts#L47-L51 "Source code on GitHub")

Pass an error to the logger

### Parameters

*   `message` **any** Flow description
*   `error` **any?** Original error object
*   `meta` **...any** non specific meta information

Returns **void** 

## recordInternalError

[src/interfaces/mixins.ts:57-60](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/mixins.ts#L57-L60 "Source code on GitHub")

Pass an internal error to the logger

### Parameters

*   `message` **any** Flow/error description
*   `meta` **...any** non specific meta information

Returns **void** 

## recordWarning

[src/interfaces/mixins.ts:66-69](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/mixins.ts#L66-L69 "Source code on GitHub")

Pass an warn to the logger

### Parameters

*   `message` **any** Flow/error description
*   `meta` **...any** non specific meta information

Returns **void** 

## RequestMode

[src/interfaces/network.ts:8-22](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/network.ts#L8-L22 "Source code on GitHub")

Plugin more for handling requests

### ignore

[src/interfaces/network.ts:12-12](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/network.ts#L12-L12 "Source code on GitHub")

Plugin will do nothing about original request

Type: [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)

### native

[src/interfaces/network.ts:17-17](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/network.ts#L17-L17 "Source code on GitHub")

Plugin will just listen to the original request/response data and all requests will fulfilled by puppeteer itself.
But some plugin functionality can be unavailable.

Type: [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)

### managed

[src/interfaces/network.ts:21-21](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/network.ts#L21-L21 "Source code on GitHub")

Plugin will do all requests by himself. All plugin features will be available.

Type: [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)

## RequestStage

[src/interfaces/network.ts:27-66](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/network.ts#L27-L66 "Source code on GitHub")

Current stage of the request

### gotRequest

[src/interfaces/network.ts:36-36](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/network.ts#L36-L36 "Source code on GitHub")

We got a new request from the puppeteer witch includes all necessary information about.

At this stage we can adjust request.

Type: [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)

### sentRequest

[src/interfaces/network.ts:43-43](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/network.ts#L43-L43 "Source code on GitHub")

The request in requesting process

At this stage we unable to adjust request but still have not response to go forward.

Type: [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)

### gotResponse

[src/interfaces/network.ts:51-51](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/network.ts#L51-L51 "Source code on GitHub")

We got response from the request witch probably was modified by the user and now user can adjust the response.

At this stage we can adjust response.
At this stage the user will unable to override the request anymore.

Type: [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)

### sentResponse

[src/interfaces/network.ts:58-58](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/network.ts#L58-L58 "Source code on GitHub")

We sent final response of the request to the browser.

Its too late to adjust request or response.

Type: [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)

### closed

[src/interfaces/network.ts:65-65](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/network.ts#L65-L65 "Source code on GitHub")

Page were closed and we unable do anything

From technical perspective `sentResponse` looks just the same

Type: [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)

## IRequestOptions

[src/interfaces/network.ts:73-103](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/network.ts#L73-L103 "Source code on GitHub")

Plugin' request options. The request have significant difference with Puppeteer' request.

Can be modified. All changes will be applied to the actual Puppeteer' request and will be executed

### method

[src/interfaces/network.ts:79-79](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/network.ts#L79-L79 "Source code on GitHub")

Request method.

If request were executed you will unable to change this property.

Type: Method

### url

[src/interfaces/network.ts:86-86](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/network.ts#L86-L86 "Source code on GitHub")

Request url.

If request were executed you will unable to change this property.

Type: [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)

### headers

[src/interfaces/network.ts:93-93](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/network.ts#L93-L93 "Source code on GitHub")

Request headers.

If request were executed you will unable to change this property.

Type: [Headers](https://developer.mozilla.org/docs/Web/HTML/Element/header)

### body

[src/interfaces/network.ts:100-100](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/network.ts#L100-L100 "Source code on GitHub")

Request body.

If request were executed you will unable to change this property.

Type: ([string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String) | [Buffer](https://nodejs.org/api/buffer.html) | [undefined](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/undefined))

## IAbortReason

[src/interfaces/network.ts:130-130](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/interfaces/network.ts#L112-L129 "Source code on GitHub")

This option will override the response

*   `aborted` - An operation was aborted (due to user action).
*   `accessdenied` - Permission to access a resource, other than the network, was denied.
*   `addressunreachable` - The IP address is unreachable. This usually means

that there is no route to the specified host or network.

*   `blockedbyclient` - The client chose to block the request.
*   `blockedbyresponse` - The request failed because the response was delivered along with requirements which are not met ('X-Frame-Options' and 'Content-Security-Policy' ancestor checks, for instance).
*   `connectionaborted` - A connection timed out as a result of not receiving an ACK for data sent.
*   `connectionclosed` - A connection was closed (corresponding to a TCP FIN).
*   `connectionfailed` - A connection attempt failed.
*   `connectionrefused` - A connection attempt was refused.
*   `connectionreset` - A connection was reset (corresponding to a TCP RST).
*   `internetdisconnected` - The Internet connection has been lost.
*   `namenotresolved` - The host name could not be resolved.
*   `timedout` - An operation timed out.
*   `failed` - A generic failure occurred.

Type: ErrorCode

## InterceptionProxyRequest

[src/classes/Request.ts:38-235](https://github.com/utyfua/automation-extra-interception-proxy/blob/32431b84abed5c07ed428260519fbd83f7aa4aeb/src/classes/Request.ts#L38-L235 "Source code on GitHub")

**Extends RequestBase**

Plugin' request. The request have significant difference with Puppeteer' request.

### Parameters

*   `initial` **INewRequestInitialArgs** 
*   `requestOptions` **[IRequestOptions](#irequestoptions)** 

# TODO:

*   finalize cors managed requests - need to pass cors test
*   add tests
*   *   plugin flow
*   *   [cookies](https://github.com/puppeteer/puppeteer/blob/main/test/cookies.spec.ts)
*   documentation
*   *   improve `docs` command
*   *   describe `wrapPage`
*   *   describe `InterceptionProxyPlugin` class
*   add more proxy api
*   *   waitRequest
*   data url support
*   websocket support
*   migrate to [automation-extra-plugin](https://www.npmjs.com/package/automation-extra-plugin)

<!--
# notes?

More specified example. We have Google ReCaptcha to solve. But when you going to automate this thing you will got an error. From first looks it will looks like... TODO?
-->

# License

Copyright © 2021 - 2022, Utyfua. Released under the MIT License.
